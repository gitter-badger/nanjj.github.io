<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-03-17 Sun 23:34 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LXD Snap LXD</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="JUNJIE NAN" />
<link rel="stylesheet" type="text/css" href="css/org.css" />
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="index.html"> UP </a> |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content">
<h1 class="title">LXD Snap LXD</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge2fd4fa">LXD Setup</a>
<ul>
<li><a href="#org43ebb18">Deb or Snap</a></li>
<li><a href="#org72588bc">Init</a></li>
</ul>
</li>
<li><a href="#org5af360b">Snap and Lxd</a>
<ul>
<li><a href="#org717dd55">Run lxd in Snap</a></li>
<li><a href="#org7c6e935">Launcn Lxd container</a></li>
<li><a href="#org5488255">Run snap inside Lxd Container</a></li>
<li><a href="#org87132e6">Run Lxd inside Lxd Container</a></li>
<li><a href="#orge89ad38">Run Docker inside Lxd Container</a></li>
<li><a href="#org85f4ee2">Use Lxd Container as a Router</a></li>
</ul>
</li>
<li><a href="#org7e349e5">Clustering Mode</a>
<ul>
<li><a href="#org3338430">New Cluster</a></li>
<li><a href="#org7e759b7">Join Cluster</a></li>
<li><a href="#orgbeeed40">List Cluster</a></li>
</ul>
</li>
<li><a href="#orgc8b698d">Database</a>
<ul>
<li><a href="#org6a3f223">Global and Local</a></li>
<li><a href="#orgc7fc03b">Lxd sql</a></li>
<li><a href="#org8cbff28">Global Schemas</a></li>
<li><a href="#org510ebb8">Local Schemas</a></li>
<li><a href="#org5ee6798">Raft Nodes</a></li>
<li><a href="#orgcf99e3b">Cluster nodes</a></li>
<li><a href="#org033fbc0">Containers</a></li>
</ul>
</li>
<li><a href="#org41458a7">Network</a></li>
<li><a href="#org57ef812">Operations</a>
<ul>
<li><a href="#orgfd50061">Launch Container</a></li>
</ul>
</li>
<li><a href="#orgdbadd6e">Ansible</a>
<ul>
<li><a href="#org205840b">Lxd connection</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orge2fd4fa" class="outline-2">
<h2 id="orge2fd4fa">LXD Setup</h2>
<div class="outline-text-2" id="text-orge2fd4fa">
<p>
So easy to setup LXD!
</p>
</div>
<div id="outline-container-org43ebb18" class="outline-3">
<h3 id="org43ebb18">Deb or Snap</h3>
<div class="outline-text-3" id="text-org43ebb18">
<p>
The existing lxd packages in ubuntu 16.04 are too old to use, which
need to be purged:
</p>
<div class="org-src-container">
<pre class="src src-sh">apt-get -qq purge lxd lxd-client
snap install lxd
</pre>
</div>

<p>
<code>lxd</code> is lxd daemon and <code>lxc</code> is the lxd client:
</p>
<div class="org-src-container">
<pre class="src src-sh">which lxd <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt;</span>
/snap/bin/lxd
which lxc <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt;</span>
/snap/bin/lxc
</pre>
</div>
</div>
</div>

<div id="outline-container-org72588bc" class="outline-3">
<h3 id="org72588bc">Init</h3>
<div class="outline-text-3" id="text-org72588bc">
<p>
<code>lxd</code> provides a sub command <code>init</code> to init lxd:
</p>
<div class="org-src-container">
<pre class="src src-sh">lxd init
</pre>
</div>

<p>
<code>lxd init</code> can configure <code>lxd</code> run in clustering mode or standalone
mode.
</p>
</div>
</div>
</div>

<div id="outline-container-org5af360b" class="outline-2">
<h2 id="org5af360b">Snap and Lxd</h2>
<div class="outline-text-2" id="text-org5af360b">
<p>
You can use <code>snap</code> to run <code>lxd</code>, or the opposite. Inside <code>lxd</code> you
can run <code>docker</code>.
</p>

<div class="org-src-container">
<pre class="src src-artist">+----------+       +-----------+       +------------+        +-----------+
|          |       |           |       |            |        |           |
|    vm    +------&gt;|    snap   +------&gt;|     lxd    +-------&gt;|   docker  |
|          |       |           |       |            |        |           |
+----------+       +-----------+       +------+-----+        +-----------+
                         ^                    |
                         |                    |
                         +--------------------+
</pre>
</div>
</div>

<div id="outline-container-org717dd55" class="outline-3">
<h3 id="org717dd55">Run lxd in Snap</h3>
<div class="outline-text-3" id="text-org717dd55">
<p>
By default ubuntu xenial with lxd and lxd client installed. You can
check this by running:
</p>

<div class="org-src-container">
<pre class="src src-sh">which lxd                       <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; /usr/bin/lxd</span>
which lxc                       <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; /usr/bin/lxc</span>
</pre>
</div>

<p>
The lxd in apt repo is very low. We need to switch to the lxd in
snap store:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Uninstall existing lxd in ubuntu repo.</span>
apt-get purge -qq lxd lxd-client
<span class="org-comment-delimiter"># </span><span class="org-comment">Install lxd in snap</span>
snap install lxd
<span class="org-comment-delimiter"># </span><span class="org-comment">Check lxd and lxc</span>
which lxd                       <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; /snap/bin/lxd</span>
lxd --version                   <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; 3.3</span>
which lxc                       <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; /snap/bin/lxc</span>
lxc --version                   <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; 3.3</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Init lxd</span>
lxd init
<span class="org-comment-delimiter"># </span><span class="org-comment">Start lxd</span>
snap restart lxd
</pre>
</div>
</div>
</div>

<div id="outline-container-org7c6e935" class="outline-3">
<h3 id="org7c6e935">Launcn Lxd container</h3>
<div class="outline-text-3" id="text-org7c6e935">
<p>
Now launch a vm like <code>lxc</code> container:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">List images</span>
snap image list ubuntu:xenial
<span class="org-comment-delimiter"># </span><span class="org-comment">Launch a container</span>
lxc launch ubuntu:xenial/amd64
<span class="org-comment-delimiter"># </span><span class="org-comment">List containers</span>
lxc list
<span class="org-comment-delimiter"># </span><span class="org-comment">exec bash in the container</span>
lxc exec steady-dingo bash
<span class="org-comment-delimiter"># </span><span class="org-comment">Now you can do anything in the container</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5488255" class="outline-3">
<h3 id="org5488255">Run snap inside Lxd Container</h3>
<div class="outline-text-3" id="text-org5488255">
<p>
Snap as a container, can run <code>lxd</code> and launch <code>lxd</code>
container. Inside the <code>lxc</code> container, you can run <code>snap</code>
container, say to install go snap:
</p>
<div class="org-src-container">
<pre class="src src-sh">lxc exec steady-dingo bash
snap install go --classic
<span class="org-builtin">echo</span> <span class="org-string">'export GOPATH=/usr/local'</span> &gt;&gt; ~/.bashrc
apt-get install build-essential
cat &gt; ~/.netrc &lt;&lt;EOF
<span class="org-sh-heredoc">  your github toke  n</span>
<span class="org-sh-heredoc">EOF</span>
go get github.ibm.com/nanjj/ncatd
ncatd --version                 <span class="org-comment-delimiter"># </span><span class="org-comment">ncatd version 0.0.1</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org87132e6" class="outline-3">
<h3 id="org87132e6">Run Lxd inside Lxd Container</h3>
<div class="outline-text-3" id="text-org87132e6">
<p>
Run <code>lxd</code> inside lxd container nesting:
</p>
<div class="org-src-container">
<pre class="src src-sh">lxc config set steady-dingo security.nesting true
lxc exec steady-dingo bash
apt-get purge -qq lxd lxd-client
snap install lxd
lxd init
lxc launch ubuntu:xenial/amd64
</pre>
</div>
</div>
</div>

<div id="outline-container-orge89ad38" class="outline-3">
<h3 id="orge89ad38">Run Docker inside Lxd Container</h3>
<div class="outline-text-3" id="text-orge89ad38">
<p>
With <code>security.nesting true</code>, run docker:
</p>

<div class="org-src-container">
<pre class="src src-sh">apt-get install docker.io
docker run hello-world
</pre>
</div>
</div>
</div>

<div id="outline-container-org85f4ee2" class="outline-3">
<h3 id="org85f4ee2">Use Lxd Container as a Router</h3>
<div class="outline-text-3" id="text-org85f4ee2">
<div class="org-src-container">
<pre class="src src-sh">lxc launch ubuntu:16.04 router <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt;</span>
lxc list <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt;</span>
+--------+---------+-----------------------+------+------------+-----------+
|  NAME  |  STATE  |         IPV4          | IPV6 |    TYPE    | SNAPSHOTS |
+--------+---------+-----------------------+------+------------+-----------+
| router | RUNNING |  10.149.11.203 (eth0) |      | PERSISTENT |           |
+--------+---------+-----------------------+------+------------+-----------+
lxc exec router -- bash -i
<span class="org-comment-delimiter"># </span><span class="org-comment">configure vpn if needed</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">check ip forward setting</span>
sysctl net.ipv4.ip_forward <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt;</span>
net.ipv4.ip_forward = 1
<span class="org-comment-delimiter"># </span><span class="org-comment">iptables</span>
iptables -t nat -A POSTROUTING -s 10.149.11.0/24 ! -d 10.0.2.0/24 -j MASQUERADE
apt-get update
apt-get install iptables-persistent
</pre>
</div>
<p>
Now you can use this as a router
</p>
</div>
</div>
</div>

<div id="outline-container-org7e349e5" class="outline-2">
<h2 id="org7e349e5">Clustering Mode</h2>
<div class="outline-text-2" id="text-org7e349e5">
<p>
Lxd clustering mode makes lxd run in multiple nodes. Each node lxd
is running on is a cluster member. The whole set of the cluster
members is called a cluster.
</p>
</div>

<div id="outline-container-org3338430" class="outline-3">
<h3 id="org3338430">New Cluster</h3>
<div class="outline-text-3" id="text-org3338430">
<div class="org-src-container">
<pre class="src src-sh">lxd init
Would you like to use LXD clustering? (yes/no) [<span class="org-variable-name">default</span>=no]: yes
What name should be used to identify this node<span class="org-keyword"> in</span> the cluster? [<span class="org-variable-name">default</span>=hypercube01]:
What IP address or DNS name should be used to reach this node? [<span class="org-variable-name">default</span>=192.168.0.46]:
Are you joining an existing cluster? (yes/no) [<span class="org-variable-name">default</span>=no]:
Setup password authentication on the cluster? (yes/no) [<span class="org-variable-name">default</span>=yes]: yes
Trust password for new clients:
Again:
Do you want to configure a new local storage pool? (yes/no) [<span class="org-variable-name">default</span>=yes]:
Name of the storage backend to use (btrfs, dir, lvm, zfs) [<span class="org-variable-name">default</span>=zfs]:
Create a new ZFS pool? (yes/no) [<span class="org-variable-name">default</span>=yes]:
Would you like to use an existing block device? (yes/no) [<span class="org-variable-name">default</span>=no]:
Size<span class="org-keyword"> in</span> GB of the new loop device (1GB minimum) [<span class="org-variable-name">default</span>=31GB]: 128GB
Do you want to configure a new remote storage pool? (yes/no) [<span class="org-variable-name">default</span>=no]:
Would you like to connect to a MAAS server? (yes/no) [<span class="org-variable-name">default</span>=no]:
Would you like to configure LXD to use an existing bridge or host interface? (yes/no) [<span class="org-variable-name">default</span>=no]:
Would you like to create a new Fan overlay network? (yes/no) [<span class="org-variable-name">default</span>=yes]:
What subnet should be used as the Fan underlay? [<span class="org-variable-name">default</span>=auto]:
Would you like stale cached images to be updated automatically? (yes/no) [<span class="org-variable-name">default</span>=yes]
Would you like a YAML <span class="org-string">"lxd init"</span> preseed to be printed? (yes/no) [<span class="org-variable-name">default</span>=no]:
</pre>
</div>
</div>
</div>
<div id="outline-container-org7e759b7" class="outline-3">
<h3 id="org7e759b7">Join Cluster</h3>
<div class="outline-text-3" id="text-org7e759b7">
<div class="org-src-container">
<pre class="src src-sh">lxd init
Would you like to use LXD clustering? (yes/no) [<span class="org-variable-name">default</span>=no]: yes
What name should be used to identify this node<span class="org-keyword"> in</span> the cluster? [<span class="org-variable-name">default</span>=hypercube06]:
What IP address or DNS name should be used to reach this node? [<span class="org-variable-name">default</span>=192.168.0.21]:
Are you joining an existing cluster? (yes/no) [<span class="org-variable-name">default</span>=no]: yes
IP address or FQDN of an existing cluster node: 192.168.0.30
Cluster fingerprint: 6ab5b519ffbb309cb38b73657299dd9b0b8c6f2bd5b359974bf3bc77ce9c8977
You can validate this fingerprint by running <span class="org-string">"lxc info"</span> locally on an existing node.
Is this the correct fingerprint? (yes/no) [<span class="org-variable-name">default</span>=no]: yes
Cluster trust password:
All existing data is lost when joining a cluster, continue? (yes/no) [<span class="org-variable-name">default</span>=no] yes
Choose <span class="org-string">"size"</span> property for storage pool <span class="org-string">"local"</span>: 128GB
Choose <span class="org-string">"source"</span> property for storage pool <span class="org-string">"local"</span>:
Choose <span class="org-string">"zfs.pool_name"</span> property for storage pool <span class="org-string">"local"</span>:
Would you like a YAML <span class="org-string">"lxd init"</span> preseed to be printed? (yes/no) [<span class="org-variable-name">default</span>=no]:
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbeeed40" class="outline-3">
<h3 id="orgbeeed40">List Cluster</h3>
<div class="outline-text-3" id="text-orgbeeed40">
<div class="org-src-container">
<pre class="src src-sh">lxc cluster list

+-------------+---------------------------+----------+--------+-------------------+
|    NAME     |            URL            | DATABASE | STATE  |      MESSAGE      |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube01 | https://192.168.0.46:8443 | YES      | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube02 | https://192.168.0.47:8443 | YES      | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube03 | https://192.168.0.48:8443 | YES      | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube04 | https://192.168.0.51:8443 | NO       | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube05 | https://192.168.0.30:8443 | NO       | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube06 | https://192.168.0.21:8443 | NO       | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
| hypercube07 | https://192.168.0.26:8443 | NO       | ONLINE | fully operational |
+-------------+---------------------------+----------+--------+-------------------+
</pre>
</div>
<p>
It's a 7 nodes lxd cluster with 3 database nodes and 7 service
nodes.
</p>
</div>
</div>
</div>
<div id="outline-container-orgc8b698d" class="outline-2">
<h2 id="orgc8b698d">Database</h2>
<div class="outline-text-2" id="text-orgc8b698d">
<p>
<a href="https://github.com/lxc/lxd/blob/master/doc/database.md">Lxd database</a> is based on <a href="https://github.com/CanonicalLtd/dqlite">distributed sqlite</a>, which removed lxd's
dependency on traditional database like postgres or mysql. <a href="https://wiki.ubuntu.com/FanNetworking">Fan
network</a> introduced lxd a simple and fast container network.
</p>
</div>
<div id="outline-container-org6a3f223" class="outline-3">
<h3 id="org6a3f223">Global and Local</h3>
<div class="outline-text-3" id="text-org6a3f223">
<p>
For each lxd node, there are two type databases: global and
local. Data in global database is shared by each lxd cluster
members, while data in local database can only be accessed in
local node, does not impact others.
</p>
</div>
</div>
<div id="outline-container-orgc7fc03b" class="outline-3">
<h3 id="orgc7fc03b">Lxd sql</h3>
<div class="outline-text-3" id="text-orgc7fc03b">
<div class="org-src-container">
<pre class="src src-sh">lxd sql &lt;local|global&gt; &lt;query&gt;  [flags]
</pre>
</div>
</div>
</div>
<div id="outline-container-org8cbff28" class="outline-3">
<h3 id="org8cbff28">Global Schemas</h3>
<div class="outline-text-3" id="text-org8cbff28">
<p>
For example, to list global schemas:
</p>
<div class="org-src-container">
<pre class="src src-sh">lxd sql global .schema <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt;</span>
PRAGMA <span class="org-variable-name">foreign_keys</span>=OFF;
BEGIN TRANSACTION;
CREATE TABLE schema (
    id         INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    version    INTEGER NOT NULL,
    updated_at DATETIME NOT NULL,
    UNIQUE (version)
);
INSERT INTO schema VALUES(1,13,1546788241);
CREATE TABLE <span class="org-string">"containers"</span> (
    id INTEGER primary key AUTOINCREMENT NOT NULL,
    node_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    architecture INTEGER NOT NULL,
    <span class="org-builtin">type</span> INTEGER NOT NULL,
    ephemeral INTEGER NOT NULL DEFAULT 0,
    creation_date DATETIME NOT NULL DEFAULT 0,
    stateful INTEGER NOT NULL DEFAULT 0,
    last_use_date DATETIME,
    description TEXT,
    project_id INTEGER NOT NULL,
    UNIQUE (project_id, name),
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
);
CREATE TABLE <span class="org-string">"images"</span> (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    fingerprint TEXT NOT NULL,
    filename TEXT NOT NULL,
    size INTEGER NOT NULL,
    public INTEGER NOT NULL DEFAULT 0,
    architecture INTEGER NOT NULL,
    creation_date DATETIME,
    expiry_date DATETIME,
    upload_date DATETIME NOT NULL,
    cached INTEGER NOT NULL DEFAULT 0,
    last_use_date DATETIME,
    auto_update INTEGER NOT NULL DEFAULT 0,
    project_id INTEGER NOT NULL,
    UNIQUE (project_id, fingerprint),
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
);
CREATE TABLE <span class="org-string">"images_aliases"</span> (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    image_id INTEGER NOT NULL,
    description TEXT,
    project_id INTEGER NOT NULL,
    UNIQUE (project_id, name),
    FOREIGN KEY (image_id) REFERENCES images (id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
);
CREATE TABLE <span class="org-string">"operations"</span> (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    uuid TEXT NOT NULL,
    node_id TEXT NOT NULL,
    <span class="org-builtin">type</span> INTEGER NOT NULL DEFAULT 0,
    project_id INTEGER,
    UNIQUE (uuid),
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
);
CREATE TABLE <span class="org-string">"profiles"</span> (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    project_id INTEGER NOT NULL,
    UNIQUE (project_id, name),
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
);
CREATE TABLE <span class="org-string">"storage_volumes"</span> (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    storage_pool_id INTEGER NOT NULL,
    node_id INTEGER NOT NULL,
    <span class="org-builtin">type</span> INTEGER NOT NULL,
    description TEXT,
    snapshot INTEGER NOT NULL DEFAULT 0,
    project_id INTEGER NOT NULL,
    UNIQUE (storage_pool_id, node_id, project_id, name, type),
    FOREIGN KEY (storage_pool_id) REFERENCES storage_pools (id) ON DELETE CASCADE,
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
);
CREATE TABLE certificates (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    fingerprint TEXT NOT NULL,
    <span class="org-builtin">type</span> INTEGER NOT NULL,
    name TEXT NOT NULL,
    certificate TEXT NOT NULL,
    UNIQUE (fingerprint)
);
CREATE TABLE config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    UNIQUE (key)
);
CREATE TABLE containers_backups (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    container_id INTEGER NOT NULL,
    name VARCHAR(255) NOT NULL,
    creation_date DATETIME,
    expiry_date DATETIME,
    container_only INTEGER NOT NULL default 0,
    optimized_storage INTEGER NOT NULL default 0,
    FOREIGN KEY (container_id) REFERENCES containers (id) ON DELETE CASCADE,
    UNIQUE (container_id, name)
);
CREATE TABLE containers_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    container_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    FOREIGN KEY (container_id) REFERENCES containers (id) ON DELETE CASCADE,
    UNIQUE (container_id, key)
);
CREATE TABLE containers_devices (
    id INTEGER primary key AUTOINCREMENT NOT NULL,
    container_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    <span class="org-builtin">type</span> INTEGER NOT NULL default 0,
    FOREIGN KEY (container_id) REFERENCES containers (id) ON DELETE CASCADE,
    UNIQUE (container_id, name)
);
CREATE TABLE containers_devices_config (
    id INTEGER primary key AUTOINCREMENT NOT NULL,
    container_device_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    FOREIGN KEY (container_device_id) REFERENCES containers_devices (id) ON DELETE CASCADE,
    UNIQUE (container_device_id, key)
);
CREATE TABLE containers_profiles (
    id INTEGER primary key AUTOINCREMENT NOT NULL,
    container_id INTEGER NOT NULL,
    profile_id INTEGER NOT NULL,
    apply_order INTEGER NOT NULL default 0,
    UNIQUE (container_id, profile_id),
    FOREIGN KEY (container_id) REFERENCES containers(id) ON DELETE CASCADE,
    FOREIGN KEY (profile_id) REFERENCES profiles(id) ON DELETE CASCADE
);
CREATE TABLE images_nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    image_id INTEGER NOT NULL,
    node_id INTEGER NOT NULL,
    UNIQUE (image_id, node_id),
    FOREIGN KEY (image_id) REFERENCES images (id) ON DELETE CASCADE,
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE
);
CREATE TABLE images_properties (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    image_id INTEGER NOT NULL,
    <span class="org-builtin">type</span> INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    FOREIGN KEY (image_id) REFERENCES images (id) ON DELETE CASCADE
);
CREATE TABLE images_source (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    image_id INTEGER NOT NULL,
    server TEXT NOT NULL,
    protocol INTEGER NOT NULL,
    certificate TEXT NOT NULL,
    <span class="org-builtin">alias</span> TEXT NOT NULL,
    FOREIGN KEY (image_id) REFERENCES images (id) ON DELETE CASCADE
);
CREATE TABLE networks (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    state INTEGER NOT NULL DEFAULT 0,
    UNIQUE (name)
);
CREATE TABLE networks_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    network_id INTEGER NOT NULL,
    node_id INTEGER,
    key TEXT NOT NULL,
    value TEXT,
    UNIQUE (network_id, node_id, key),
    FOREIGN KEY (network_id) REFERENCES networks (id) ON DELETE CASCADE,
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE
);
CREATE TABLE networks_nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    network_id INTEGER NOT NULL,
    node_id INTEGER NOT NULL,
    UNIQUE (network_id, node_id),
    FOREIGN KEY (network_id) REFERENCES networks (id) ON DELETE CASCADE,
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE
);
CREATE TABLE nodes (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT DEFAULT <span class="org-string">''</span>,
    address TEXT NOT NULL,
    schema INTEGER NOT NULL,
    api_extensions INTEGER NOT NULL,
    heartbeat DATETIME DEFAULT CURRENT_TIMESTAMP,
    pending INTEGER NOT NULL DEFAULT 0,
    UNIQUE (name),
    UNIQUE (address)
);
CREATE TABLE profiles_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    profile_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    UNIQUE (profile_id, key),
    FOREIGN KEY (profile_id) REFERENCES profiles(id) ON DELETE CASCADE
);
CREATE TABLE profiles_devices (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    profile_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    <span class="org-builtin">type</span> INTEGER NOT NULL default 0,
    UNIQUE (profile_id, name),
    FOREIGN KEY (profile_id) REFERENCES profiles (id) ON DELETE CASCADE
);
CREATE TABLE profiles_devices_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    profile_device_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    UNIQUE (profile_device_id, key),
    FOREIGN KEY (profile_device_id) REFERENCES profiles_devices (id) ON DELETE CASCADE
);
CREATE TABLE projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    UNIQUE (name)
);
CREATE TABLE projects_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    project_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE,
    UNIQUE (project_id, key)
);
CREATE TABLE storage_pools (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    driver TEXT NOT NULL,
    description TEXT,
    state INTEGER NOT NULL DEFAULT 0,
    UNIQUE (name)
);
CREATE TABLE storage_pools_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    storage_pool_id INTEGER NOT NULL,
    node_id INTEGER,
    key TEXT NOT NULL,
    value TEXT,
    UNIQUE (storage_pool_id, node_id, key),
    FOREIGN KEY (storage_pool_id) REFERENCES storage_pools (id) ON DELETE CASCADE,
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE
);
CREATE TABLE storage_pools_nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    storage_pool_id INTEGER NOT NULL,
    node_id INTEGER NOT NULL,
    UNIQUE (storage_pool_id, node_id),
    FOREIGN KEY (storage_pool_id) REFERENCES storage_pools (id) ON DELETE CASCADE,
    FOREIGN KEY (node_id) REFERENCES nodes (id) ON DELETE CASCADE
);
CREATE TABLE storage_volumes_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    storage_volume_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    UNIQUE (storage_volume_id, key),
    FOREIGN KEY (storage_volume_id) REFERENCES storage_volumes (id) ON DELETE CASCADE
);
COMMIT;
</pre>
</div>
</div>
</div>
<div id="outline-container-org510ebb8" class="outline-3">
<h3 id="org510ebb8">Local Schemas</h3>
<div class="outline-text-3" id="text-org510ebb8">
<p>
To list local database schemas:
</p>
<div class="org-src-container">
<pre class="src src-sh">lxd sql local .schema <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt;</span>
PRAGMA <span class="org-variable-name">foreign_keys</span>=OFF;
BEGIN TRANSACTION;
CREATE TABLE schema (
    id         INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    version    INTEGER NOT NULL,
    updated_at DATETIME NOT NULL,
    UNIQUE (version)
);
INSERT INTO schema VALUES(1,38,1546788240);
CREATE TABLE config (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    key VARCHAR(255) NOT NULL,
    value TEXT,
    UNIQUE (key)
);
CREATE TABLE patches (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name VARCHAR(255) NOT NULL,
    applied_at DATETIME NOT NULL,
    UNIQUE (name)
);
CREATE TABLE raft_nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    address TEXT NOT NULL,
    UNIQUE (address)
);
COMMIT;
</pre>
</div>
</div>
</div>
<div id="outline-container-org5ee6798" class="outline-3">
<h3 id="org5ee6798">Raft Nodes</h3>
<div class="outline-text-3" id="text-org5ee6798">
<div class="org-src-container">
<pre class="src src-sh">lxd sql local <span class="org-string">'select * from raft_nodes'</span> <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt;</span>
+----+-------------------+
| id |      address      |
+----+-------------------+
| 1  | 192.168.0.46:8443 |
| 2  | 192.168.0.47:8443 |
| 3  | 192.168.0.48:8443 |
+----+-------------------+
</pre>
</div>
<p>
<a href="https://github.com/CanonicalLtd/dqlite">Distributed Sqlite</a> is using raft to sync sqlite db logs.
</p>
</div>
</div>
<div id="outline-container-orgcf99e3b" class="outline-3">
<h3 id="orgcf99e3b">Cluster nodes</h3>
<div class="outline-text-3" id="text-orgcf99e3b">
<div class="org-src-container">
<pre class="src src-sh">lxd sql global <span class="org-string">'select * from nodes'</span>
+----+-------------+-------------------+--------+----------------+--------------------------------+---------+
| id |    name     |      address      | schema | api_extensions |           heartbeat            | pending |
+----+-------------+-------------------+--------+----------------+--------------------------------+---------+
| 1  | hypercube01 | 192.168.0.46:8443 | 13     | 115            | 2019-01-29T12:09:42.37271017Z  | 0       |
| 2  | hypercube02 | 192.168.0.47:8443 | 13     | 115            | 2019-01-29T12:09:42.45776374Z  | 0       |
| 3  | hypercube03 | 192.168.0.48:8443 | 13     | 115            | 2019-01-29T12:09:42.521913386Z | 0       |
| 4  | hypercube04 | 192.168.0.51:8443 | 13     | 115            | 2019-01-29T12:09:42.599993638Z | 0       |
| 5  | hypercube05 | 192.168.0.30:8443 | 13     | 115            | 2019-01-29T12:09:42.661997234Z | 0       |
| 6  | hypercube06 | 192.168.0.21:8443 | 13     | 115            | 2019-01-29T12:09:42.733539797Z | 0       |
| 7  | hypercube07 | 192.168.0.26:8443 | 13     | 115            | 2019-01-29T12:09:42.796405819Z | 0       |
+----+-------------+-------------------+--------+----------------+--------------------------------+---------+
</pre>
</div>
</div>
</div>
<div id="outline-container-org033fbc0" class="outline-3">
<h3 id="org033fbc0">Containers</h3>
<div class="outline-text-3" id="text-org033fbc0">
<div class="org-src-container">
<pre class="src src-sh">lxd sql global <span class="org-string">'select * from containers'</span> <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt;</span>
+----+---------+----------------+------------+
| id | node_id |      name      | project_id |
+----+---------+----------------+------------+
| 20 | 2       | grafana        | 1          |
| 30 | 3       | go             | 1          |
| 32 | 1       | guyujie        | 1          |
| 33 | 4       | nginx          | 1          |
| 36 | 1       | lxdui01        | 1          |
| 38 | 1       | crack-mako     | 1          |
| 39 | 5       | lxdui02        | 1          |
| 42 | 6       | fluent-hamster | 1          |
| 43 | 1       | b2             | 1          |
| 44 | 2       | b3             | 1          |
+----+---------+----------------+------------+
</pre>
</div>
<p>
To select the node with least containers:
</p>
<div class="org-src-container">
<pre class="src src-sh">lxd sql global <span class="org-sh-escaped-newline">\</span>
    <span class="org-string">'select node_id, count(node_id) as node_count from containers</span>
<span class="org-string">     group by node_id order by node_count'</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org41458a7" class="outline-2">
<h2 id="org41458a7">Network</h2>
<div class="outline-text-2" id="text-org41458a7">
<p>
Lxd can be configured to use <a href="https://wiki.ubuntu.com/FanNetworking">Ubuntu Fan Network</a>.
</p>

<p>
Say 2 containers A and B:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Container</th>
<th scope="col" class="org-left">IP</th>
<th scope="col" class="org-left">Hyper</th>
<th scope="col" class="org-left">Hyper IP</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">A</td>
<td class="org-left">240.0.46.14/8</td>
<td class="org-left">hypercube01</td>
<td class="org-left">192.168.0.46/16</td>
</tr>

<tr>
<td class="org-left">B</td>
<td class="org-left">240.0.47.99/8</td>
<td class="org-left">hypercube02</td>
<td class="org-left">192.168.0.47/16</td>
</tr>
</tbody>
</table>

<p>
Now ping B on A:
</p>
<div class="org-src-container">
<pre class="src src-sh">ping 240.0.47.99 <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt;</span>
ARP, Request who-has 240.0.47.99 tell 240.0.46.14, length 28
</pre>
</div>
<p>
On hypercube01 the arp request being forwarded to hypercube02:
</p>
<div class="org-src-container">
<pre class="src src-sh">17:07:29.650323 IP 192.168.0.46.53730 &gt; 192.168.0.47.8472
ARP, Request who-has 240.0.47.99 tell 240.0.46.14, length 28
</pre>
</div>
</div>
</div>
<div id="outline-container-org57ef812" class="outline-2">
<h2 id="org57ef812">Operations</h2>
<div class="outline-text-2" id="text-org57ef812">
</div>
<div id="outline-container-orgfd50061" class="outline-3">
<h3 id="orgfd50061">Launch Container</h3>
<div class="outline-text-3" id="text-orgfd50061">
<p>
<code>lxc launch b --debug</code> will do:
</p>
<ol class="org-ol">
<li><p>
Get version
</p>
<div class="org-src-container">
<pre class="src src-sh">DBUG[01-22|14:13:15] Connecting to a remote LXD over HTTPs
DBUG[01-22|14:13:15] Sending request to LXD                   <span class="org-variable-name">method</span>=GET <span class="org-variable-name">url</span>=https://192.168.0.48:8443/1.0 <span class="org-variable-name">etag</span>=
DBUG[01-22|14:13:17] Got response struct from LXD
DBUG[01-22|14:13:17]
        {
                <span class="org-string">"config"</span>: {
                        <span class="org-string">"cluster.https_address"</span>: <span class="org-string">"192.168.0.48:8443"</span>,
                        <span class="org-string">"core.https_address"</span>: <span class="org-string">"192.168.0.48:8443"</span>,
                        <span class="org-string">"core.trust_password"</span>: true
                },
                <span class="org-string">"api_extensions"</span>: [...],
                <span class="org-string">"api_status"</span>: <span class="org-string">"stable"</span>,
                <span class="org-string">"api_version"</span>: <span class="org-string">"1.0"</span>,
                <span class="org-string">"auth"</span>: <span class="org-string">"trusted"</span>,
                <span class="org-string">"public"</span>: false,
                <span class="org-string">"auth_methods"</span>: [
                        <span class="org-string">"tls"</span>
                ],
                <span class="org-string">"environment"</span>: {
                        <span class="org-string">"addresses"</span>: [
                                <span class="org-string">"192.168.0.48:8443"</span>
                        ],
                        <span class="org-string">"architectures"</span>: [
                                <span class="org-string">"x86_64"</span>,
                                <span class="org-string">"i686"</span>
                        ],
                        <span class="org-string">"certificate"</span>: <span class="org-string">"..."</span>,
                        <span class="org-string">"certificate_fingerprint"</span>: <span class="org-string">"..."</span>,
                        <span class="org-string">"driver"</span>: <span class="org-string">"lxc"</span>,
                        <span class="org-string">"driver_version"</span>: <span class="org-string">"3.1.0"</span>,
                        <span class="org-string">"kernel"</span>: <span class="org-string">"Linux"</span>,
                        <span class="org-string">"kernel_architecture"</span>: <span class="org-string">"x86_64"</span>,
                        <span class="org-string">"kernel_version"</span>: <span class="org-string">"4.15.0-43-generic"</span>,
                        <span class="org-string">"server"</span>: <span class="org-string">"lxd"</span>,
                        <span class="org-string">"server_pid"</span>: 32645,
                        <span class="org-string">"server_version"</span>: <span class="org-string">"3.9"</span>,
                        <span class="org-string">"storage"</span>: <span class="org-string">"zfs"</span>,
                        <span class="org-string">"storage_version"</span>: <span class="org-string">"0.7.5-1ubuntu16.4"</span>,
                        <span class="org-string">"server_clustered"</span>: true,
                        <span class="org-string">"server_name"</span>: <span class="org-string">"hypercube03"</span>,
                        <span class="org-string">"project"</span>: <span class="org-string">"default"</span>
                }
        }
</pre>
</div></li>
<li><p>
Get image
</p>
<div class="org-src-container">
<pre class="src src-sh">Creating the container
DBUG[01-22|14:13:17] Sending request to LXD                   <span class="org-variable-name">method</span>=GET <span class="org-variable-name">url</span>=https://192.168.0.48:8443/1.0/images/aliases/b <span class="org-variable-name">etag</span>=
DBUG[01-22|14:13:19] Got response struct from LXD
DBUG[01-22|14:13:19]
        {
                <span class="org-string">"description"</span>: <span class="org-string">""</span>,
                <span class="org-string">"target"</span>: <span class="org-string">"dcbc8e3e5c2ed9fb21c3d0659a0eee004bde52fac6616bc1453717032e52a700"</span>,
                <span class="org-string">"name"</span>: <span class="org-string">"b"</span>
        }
DBUG[01-22|14:13:19] Sending request to LXD                   <span class="org-variable-name">method</span>=GET <span class="org-variable-name">url</span>=https://192.168.0.48:8443/1.0/images/dcbc8e3e5c2ed9fb21c3d0659a0eee004bde52fac6616bc1453717032e52a700 <span class="org-variable-name">etag</span>=
DBUG[01-22|14:13:20] Got response struct from LXD
DBUG[01-22|14:13:20]
        {
                <span class="org-string">"auto_update"</span>: true,
                <span class="org-string">"properties"</span>: {
                        <span class="org-string">"architecture"</span>: <span class="org-string">"amd64"</span>,
                        <span class="org-string">"description"</span>: <span class="org-string">"ubuntu 18.04 LTS amd64 (release) (20190114)"</span>,
                        <span class="org-string">"label"</span>: <span class="org-string">"release"</span>,
                        <span class="org-string">"os"</span>: <span class="org-string">"ubuntu"</span>,
                        <span class="org-string">"release"</span>: <span class="org-string">"bionic"</span>,
                        <span class="org-string">"serial"</span>: <span class="org-string">"20190114"</span>,
                        <span class="org-string">"version"</span>: <span class="org-string">"18.04"</span>
                },
                <span class="org-string">"public"</span>: false,
                <span class="org-string">"aliases"</span>: [
                        {
                                <span class="org-string">"name"</span>: <span class="org-string">"b"</span>,
                                <span class="org-string">"description"</span>: <span class="org-string">""</span>
                        }
                ],
                <span class="org-string">"architecture"</span>: <span class="org-string">"x86_64"</span>,
                <span class="org-string">"cached"</span>: true,
                <span class="org-string">"filename"</span>: <span class="org-string">"ubuntu-18.04-server-cloudimg-amd64-lxd.tar.xz"</span>,
                <span class="org-string">"fingerprint"</span>: <span class="org-string">"dcbc8e3e5c2ed9fb21c3d0659a0eee004bde52fac6616bc1453717032e52a700"</span>,
                <span class="org-string">"size"</span>: 183468820,
                <span class="org-string">"update_source"</span>: {
                        <span class="org-string">"alias"</span>: <span class="org-string">"b"</span>,
                        <span class="org-string">"certificate"</span>: <span class="org-string">""</span>,
                        <span class="org-string">"protocol"</span>: <span class="org-string">"simplestreams"</span>,
                        <span class="org-string">"server"</span>: <span class="org-string">"https://cloud-images.ubuntu.com/releases"</span>
                },
                <span class="org-string">"created_at"</span>: <span class="org-string">"2019-01-14T00:00:00Z"</span>,
                <span class="org-string">"expires_at"</span>: <span class="org-string">"2023-04-26T00:00:00Z"</span>,
                <span class="org-string">"last_used_at"</span>: <span class="org-string">"2019-01-18T08:22:28.5476208Z"</span>,
                <span class="org-string">"uploaded_at"</span>: <span class="org-string">"2019-01-15T00:36:47.651093161Z"</span>
        }
</pre>
</div></li>
<li><p>
Create Container Operation
</p>
<div class="org-src-container">
<pre class="src src-sh">DBUG[01-22|14:13:22] Connected to the websocket
DBUG[01-22|14:13:22] Sending request to LXD                   <span class="org-variable-name">method</span>=POST <span class="org-variable-name">url</span>=https://192.168.0.48:8443/1.0/containers <span class="org-variable-name">etag</span>=
DBUG[01-22|14:13:22]
        {
                <span class="org-string">"architecture"</span>: <span class="org-string">""</span>,
                <span class="org-string">"config"</span>: {},
                <span class="org-string">"devices"</span>: {},
                <span class="org-string">"ephemeral"</span>: false,
                <span class="org-string">"profiles"</span>: null,
                <span class="org-string">"stateful"</span>: false,
                <span class="org-string">"description"</span>: <span class="org-string">""</span>,
                <span class="org-string">"name"</span>: <span class="org-string">""</span>,
                <span class="org-string">"source"</span>: {
                        <span class="org-string">"type"</span>: <span class="org-string">"image"</span>,
                        <span class="org-string">"certificate"</span>: <span class="org-string">""</span>,
                        <span class="org-string">"fingerprint"</span>: <span class="org-string">"dcbc8e3e5c2ed9fb21c3d0659a0eee004bde52fac6616bc1453717032e52a700"</span>
                },
                <span class="org-string">"instance_type"</span>: <span class="org-string">""</span>
        }
DBUG[01-22|14:13:24] Got operation from LXD
DBUG[01-22|14:13:24]
        {
                <span class="org-string">"id"</span>: <span class="org-string">"1de45646-d209-413f-827a-ef7921c3c7f8"</span>,
                <span class="org-string">"class"</span>: <span class="org-string">"task"</span>,
                <span class="org-string">"description"</span>: <span class="org-string">"Creating container"</span>,
                <span class="org-string">"created_at"</span>: <span class="org-string">"2019-01-22T06:13:23.360302136Z"</span>,
                <span class="org-string">"updated_at"</span>: <span class="org-string">"2019-01-22T06:13:23.360302136Z"</span>,
                <span class="org-string">"status"</span>: <span class="org-string">"Running"</span>,
                <span class="org-string">"status_code"</span>: 103,
                <span class="org-string">"resources"</span>: {
                        <span class="org-string">"containers"</span>: [
                                <span class="org-string">"/1.0/containers/fluent-hamster"</span>
                        ]
                },
                <span class="org-string">"metadata"</span>: null,
                <span class="org-string">"may_cancel"</span>: false,
                <span class="org-string">"err"</span>: <span class="org-string">""</span>
        }
</pre>
</div></li>
<li><p>
Wait Create Operation Done
</p>
<div class="org-src-container">
<pre class="src src-sh">DBUG[01-22|14:13:24] Sending request to LXD                   <span class="org-variable-name">method</span>=GET <span class="org-variable-name">url</span>=https://192.168.0.48:8443/1.0/operations/1de45646-d209-413f-827a-ef7921c3c7f8 <span class="org-variable-name">etag</span>=
DBUG[01-22|14:13:25] Got response struct from LXD
DBUG[01-22|14:13:25]
        {
                <span class="org-string">"id"</span>: <span class="org-string">"1de45646-d209-413f-827a-ef7921c3c7f8"</span>,
                <span class="org-string">"class"</span>: <span class="org-string">"task"</span>,
                <span class="org-string">"description"</span>: <span class="org-string">"Creating container"</span>,
                <span class="org-string">"created_at"</span>: <span class="org-string">"2019-01-22T06:13:23.360302136Z"</span>,
                <span class="org-string">"updated_at"</span>: <span class="org-string">"2019-01-22T06:13:23.360302136Z"</span>,
                <span class="org-string">"status"</span>: <span class="org-string">"Running"</span>,
                <span class="org-string">"status_code"</span>: 103,
                <span class="org-string">"resources"</span>: {
                        <span class="org-string">"containers"</span>: [
                                <span class="org-string">"/1.0/containers/fluent-hamster"</span>
                        ]
                },
                <span class="org-string">"metadata"</span>: null,
                <span class="org-string">"may_cancel"</span>: false,
                <span class="org-string">"err"</span>: <span class="org-string">""</span>
        }
Container name is: fluent-hamster
</pre>
</div></li>
<li><p>
Get container
</p>
<div class="org-src-container">
<pre class="src src-sh">DBUG[01-22|14:13:37] Sending request to LXD                   <span class="org-variable-name">method</span>=GET <span class="org-variable-name">url</span>=https://192.168.0.48:8443/1.0/containers/fluent-hamster <span class="org-variable-name">etag</span>=
DBUG[01-22|14:13:39] Got response struct from LXD
DBUG[01-22|14:13:39]
        {
                <span class="org-string">"architecture"</span>: <span class="org-string">"x86_64"</span>,
                <span class="org-string">"config"</span>: {
                        <span class="org-string">"image.architecture"</span>: <span class="org-string">"amd64"</span>,
                        <span class="org-string">"image.description"</span>: <span class="org-string">"ubuntu 18.04 LTS amd64 (release) (20190114)"</span>,
                        <span class="org-string">"image.label"</span>: <span class="org-string">"release"</span>,
                        <span class="org-string">"image.os"</span>: <span class="org-string">"ubuntu"</span>,
                        <span class="org-string">"image.release"</span>: <span class="org-string">"bionic"</span>,
                        <span class="org-string">"image.serial"</span>: <span class="org-string">"20190114"</span>,
                        <span class="org-string">"image.version"</span>: <span class="org-string">"18.04"</span>,
                        <span class="org-string">"volatile.apply_template"</span>: <span class="org-string">"create"</span>,
                        <span class="org-string">"volatile.base_image"</span>: <span class="org-string">"dcbc8e3e5c2ed9fb21c3d0659a0eee004bde52fac6616bc1453717032e52a700"</span>,
                        <span class="org-string">"volatile.eth0.hwaddr"</span>: <span class="org-string">"00:16:3e:e3:bf:17"</span>,
                        <span class="org-string">"volatile.idmap.base"</span>: <span class="org-string">"0"</span>,
                        <span class="org-string">"volatile.idmap.next"</span>: <span class="org-string">"[{\"Isuid\":true,\"Isgid\":true,\"Hostid\":1000000,\"Nsid\":0,\"Maprange\":1000000000}]"</span>,
                        <span class="org-string">"volatile.last_state.idmap"</span>: <span class="org-string">"[{\"Isuid\":true,\"Isgid\":true,\"Hostid\":1000000,\"Nsid\":0,\"Maprange\":1000000000}]"</span>
                },
                <span class="org-string">"devices"</span>: {},
                <span class="org-string">"ephemeral"</span>: false,
                <span class="org-string">"profiles"</span>: [
                        <span class="org-string">"default"</span>
                ],
                <span class="org-string">"stateful"</span>: false,
                <span class="org-string">"description"</span>: <span class="org-string">""</span>,
                <span class="org-string">"created_at"</span>: <span class="org-string">"2019-01-22T06:13:29.053538619Z"</span>,
                <span class="org-string">"expanded_config"</span>: {
                        <span class="org-string">"image.architecture"</span>: <span class="org-string">"amd64"</span>,
                        <span class="org-string">"image.description"</span>: <span class="org-string">"ubuntu 18.04 LTS amd64 (release) (20190114)"</span>,
                        <span class="org-string">"image.label"</span>: <span class="org-string">"release"</span>,
                        <span class="org-string">"image.os"</span>: <span class="org-string">"ubuntu"</span>,
                        <span class="org-string">"image.release"</span>: <span class="org-string">"bionic"</span>,
                        <span class="org-string">"image.serial"</span>: <span class="org-string">"20190114"</span>,
                        <span class="org-string">"image.version"</span>: <span class="org-string">"18.04"</span>,
                        <span class="org-string">"volatile.apply_template"</span>: <span class="org-string">"create"</span>,
                        <span class="org-string">"volatile.base_image"</span>: <span class="org-string">"dcbc8e3e5c2ed9fb21c3d0659a0eee004bde52fac6616bc1453717032e52a700"</span>,
                        <span class="org-string">"volatile.eth0.hwaddr"</span>: <span class="org-string">"00:16:3e:e3:bf:17"</span>,
                        <span class="org-string">"volatile.idmap.base"</span>: <span class="org-string">"0"</span>,
                        <span class="org-string">"volatile.idmap.next"</span>: <span class="org-string">"[{\"Isuid\":true,\"Isgid\":true,\"Hostid\":1000000,\"Nsid\":0,\"Maprange\":1000000000}]"</span>,
                        <span class="org-string">"volatile.last_state.idmap"</span>: <span class="org-string">"[{\"Isuid\":true,\"Isgid\":true,\"Hostid\":1000000,\"Nsid\":0,\"Maprange\":1000000000}]"</span>
                },
                <span class="org-string">"expanded_devices"</span>: {
                        <span class="org-string">"eth0"</span>: {
                                <span class="org-string">"name"</span>: <span class="org-string">"eth0"</span>,
                                <span class="org-string">"nictype"</span>: <span class="org-string">"bridged"</span>,
                                <span class="org-string">"parent"</span>: <span class="org-string">"lxdfan0"</span>,
                                <span class="org-string">"type"</span>: <span class="org-string">"nic"</span>
                        },
                        <span class="org-string">"root"</span>: {
                                <span class="org-string">"path"</span>: <span class="org-string">"/"</span>,
                                <span class="org-string">"pool"</span>: <span class="org-string">"local"</span>,
                                <span class="org-string">"type"</span>: <span class="org-string">"disk"</span>
                        }
                },
                <span class="org-string">"name"</span>: <span class="org-string">"fluent-hamster"</span>,
                <span class="org-string">"status"</span>: <span class="org-string">"Stopped"</span>,
                <span class="org-string">"status_code"</span>: 102,
                <span class="org-string">"last_used_at"</span>: <span class="org-string">"1970-01-01T00:00:00Z"</span>,
                <span class="org-string">"location"</span>: <span class="org-string">"hypercube06"</span>
        }
</pre>
</div></li>
<li><p>
Start Container Operation
</p>
<div class="org-src-container">
<pre class="src src-sh">Starting fluent-hamster
DBUG[01-22|14:13:39] Sending request to LXD                   <span class="org-variable-name">method</span>=PUT <span class="org-variable-name">url</span>=https://192.168.0.48:8443/1.0/containers/fluent-hamster/state <span class="org-variable-name">etag</span>=
DBUG[01-22|14:13:39]
        {
                <span class="org-string">"action"</span>: <span class="org-string">"start"</span>,
                <span class="org-string">"timeout"</span>: -1,
                <span class="org-string">"force"</span>: false,
                <span class="org-string">"stateful"</span>: false
        }
DBUG[01-22|14:13:40] Got operation from LXD
DBUG[01-22|14:13:40]
        {
                <span class="org-string">"id"</span>: <span class="org-string">"46746a23-5873-4755-a0ad-27385370aa39"</span>,
                <span class="org-string">"class"</span>: <span class="org-string">"task"</span>,
                <span class="org-string">"description"</span>: <span class="org-string">"Starting container"</span>,
                <span class="org-string">"created_at"</span>: <span class="org-string">"2019-01-22T06:13:40.232324373Z"</span>,
                <span class="org-string">"updated_at"</span>: <span class="org-string">"2019-01-22T06:13:40.232324373Z"</span>,
                <span class="org-string">"status"</span>: <span class="org-string">"Running"</span>,
                <span class="org-string">"status_code"</span>: 103,
                <span class="org-string">"resources"</span>: {
                        <span class="org-string">"containers"</span>: [
                                <span class="org-string">"/1.0/containers/fluent-hamster"</span>
                        ]
                },
                <span class="org-string">"metadata"</span>: null,
                <span class="org-string">"may_cancel"</span>: false,
                <span class="org-string">"err"</span>: <span class="org-string">""</span>
        }
</pre>
</div></li>
<li><p>
Wait Start Operation Done
</p>
<div class="org-src-container">
<pre class="src src-sh">DBUG[01-22|14:13:40] Sending request to LXD                   <span class="org-variable-name">method</span>=GET <span class="org-variable-name">url</span>=https://192.168.0.48:8443/1.0/operations/46746a23-5873-4755-a0ad-27385370aa39 <span class="org-variable-name">etag</span>=
DBUG[01-22|14:13:42] Got response struct from LXD
DBUG[01-22|14:13:42]
        {
                <span class="org-string">"id"</span>: <span class="org-string">"46746a23-5873-4755-a0ad-27385370aa39"</span>,
                <span class="org-string">"class"</span>: <span class="org-string">"task"</span>,
                <span class="org-string">"description"</span>: <span class="org-string">"Starting container"</span>,
                <span class="org-string">"created_at"</span>: <span class="org-string">"2019-01-22T06:13:40.232324373Z"</span>,
                <span class="org-string">"updated_at"</span>: <span class="org-string">"2019-01-22T06:13:40.232324373Z"</span>,
                <span class="org-string">"status"</span>: <span class="org-string">"Success"</span>,
                <span class="org-string">"status_code"</span>: 200,
                <span class="org-string">"resources"</span>: {
                        <span class="org-string">"containers"</span>: [
                                <span class="org-string">"/1.0/containers/fluent-hamster"</span>
                        ]
                },
                <span class="org-string">"metadata"</span>: null,
                <span class="org-string">"may_cancel"</span>: false,
                <span class="org-string">"err"</span>: <span class="org-string">""</span>
        }
</pre>
</div></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgdbadd6e" class="outline-2">
<h2 id="orgdbadd6e">Ansible</h2>
<div class="outline-text-2" id="text-orgdbadd6e">
</div>
<div id="outline-container-org205840b" class="outline-3">
<h3 id="org205840b">Lxd connection</h3>
<div class="outline-text-3" id="text-org205840b">
<p>
Ansible has a <code>lxd</code> connection, which can be used to manage lxd
containers.
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span class="org-type">lxdui</span>]
<span class="org-variable-name">lxdui01 ansible_host</span>=lxdui01
<span class="org-variable-name">lxdui02 ansible_host</span>=lxdui02
[<span class="org-type">lxdui:vars</span>]
<span class="org-variable-name">ansible_user</span>=root
<span class="org-variable-name">ansible_connection</span>=lxd
</pre>
</div>

<p>
To ping:
</p>
<div class="org-src-container">
<pre class="src src-sh">ansible -m ping lxdui -vvvvv <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt;</span>

ansible 2.7.6
&lt;lxdui01&gt; ESTABLISH LXD CONNECTION FOR USER: root
&lt;lxdui01&gt; EXEC /bin/sh -c <span class="org-string">'echo ~root &amp;&amp; sleep 0'</span>
&lt;lxdui02&gt; ESTABLISH LXD CONNECTION FOR USER: root
lxdui02 | SUCCESS =&gt; {
    <span class="org-string">"changed"</span>: false,
    <span class="org-string">"invocation"</span>: {
        <span class="org-string">"module_args"</span>: {
            <span class="org-string">"data"</span>: <span class="org-string">"pong"</span>
        }
    },
    <span class="org-string">"ping"</span>: <span class="org-string">"pong"</span>
}
lxdui01 | SUCCESS =&gt; {
    <span class="org-string">"changed"</span>: false,
    <span class="org-string">"invocation"</span>: {
        <span class="org-string">"module_args"</span>: {
            <span class="org-string">"data"</span>: <span class="org-string">"pong"</span>
        }
    },
    <span class="org-string">"ping"</span>: <span class="org-string">"pong"</span>
}
META: ran handlers
META: ran handlers
</pre>
</div>

<p>
It can work without ssh:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-function-name">ansible</span> (client) -&gt; lxc (client) -&gt; lxd api(server) -&gt; lxd containers
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
